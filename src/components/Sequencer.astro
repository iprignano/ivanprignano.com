---
const STEPS_LENGHT = 8;
const STEPS_ARRAY = Array.from({ length: STEPS_LENGHT }, (_, i) => i + 1);
const INSTRUMENTS = ['kick', 'snare', 'hihats'];
---

<script>
  import { audioCtx, playHihats, playKick, playSnare } from '../lib/audio';

  type State = 'idle' | 'playing' | 'paused';
  type Instrument = 'kick' | 'snare' | 'hihat';

  const INTERVAL_TIME_IN_MS = 250;

  const wrapper = document.querySelector('#wrapper');
  const instruments = (wrapper?.getAttribute('data-instruments')?.split(',') || []) as Instrument[];
  const stepsLength = Number(wrapper?.getAttribute('data-steps-length') || 8);
  const playToggle = document.querySelector('[data-play-toggle]');

  let state: State = 'idle';
  let currentStep = 0;
  let intervalId: NodeJS.Timeout;

  const highlightCurrentStep = (stepToHighlight: number) => {
    const allSteps = document.querySelectorAll('#steps th');
    [...allSteps].forEach(s => s.classList.remove('currentStep'));
    const activeStep = document.querySelector(`#steps th[data-step="${stepToHighlight}"]`);
    activeStep?.classList.add('currentStep');
  };

  const getInstrumentSteps = (instrument: Instrument) => {
    const instrumentSteps = [...document.querySelectorAll(`[data-${instrument}-step]`)].map(
      input => (input as HTMLInputElement).checked
    );
    return instrumentSteps;
  };

  const playCallback = () => {
    intervalId = setInterval(() => {
      if (currentStep >= stepsLength) {
        currentStep = 0;
      }

      currentStep++;

      const [kickSteps, snareSteps, hhSteps] = instruments.map(instr => getInstrumentSteps(instr));

      const time = audioCtx.currentTime * 1;
      if (kickSteps[currentStep - 1]) {
        playKick(time);
      }
      if (snareSteps[currentStep - 1]) {
        playSnare(time);
      }
      if (hhSteps[currentStep - 1]) {
        playHihats(time);
      }

      highlightCurrentStep(currentStep);
    }, INTERVAL_TIME_IN_MS);
  };

  playToggle?.addEventListener('click', () => {
    if (['idle', 'paused'].includes(state)) {
      if (state === 'paused') {
        audioCtx.resume();
      }
      playToggle.innerHTML = 'Pause';
      state = 'playing';
      playCallback();
    } else {
      audioCtx.suspend();
      clearInterval(intervalId);
      playToggle.innerHTML = 'Play';
      state = 'paused';
    }
  });
</script>

<div id="wrapper" data-instruments={INSTRUMENTS} data-steps-length={STEPS_LENGHT}>
  <table>
    <thead id="steps">
      <th>instrument</th>
      {STEPS_ARRAY.map(step => <th data-step={step}>{step}</th>)}
    </thead>
    <tbody>
      <tr id="kick">
        <td>Kick</td>
        {
          STEPS_ARRAY.map(step => (
            <td>
              <input data-kick-step={step} type="checkbox" />
            </td>
          ))
        }
      </tr>
      <tr id="snare">
        <td>Snare</td>
        {
          STEPS_ARRAY.map(step => (
            <td>
              <input data-snare-step={step} type="checkbox" checked />
            </td>
          ))
        }
      </tr>
      <tr id="hh">
        <td>Hi-hats</td>
        {
          STEPS_ARRAY.map(step => (
            <td>
              <input data-hihats-step={step} type="checkbox" />
            </td>
          ))
        }
      </tr>
    </tbody>
  </table>
  <button data-play-toggle>Play</button>
</div>
<style>
  .wrapper {
    width: 100%;
    max-width: 600px;
    padding: 10px;
  }

  .currentStep {
    background: yellow;
  }
</style>
